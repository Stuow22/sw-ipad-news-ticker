<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="News Ticker">
    <title>iPad News Ticker</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #0a0a0a;
            --text-color: #ffffff;
            --accent-color: #00ffff;
            --separator-color: #333333;
            --main-speed: 250s; /* Main center ticker speed */
            --top-speed: 300s; /* Top ticker speed */
            --bottom-speed: 1200s; /* Bottom ticker speed (slowest) */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Light mode */
        body.light-mode {
            --bg-color: #f5f5f5;
            --text-color: #1a1a1a;
            --accent-color: #0066cc;
            --separator-color: #cccccc;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.light-mode .header {
            background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header .timestamp {
            font-size: 1em;
            margin-top: 10px;
            opacity: 0.8;
            color: var(--text-color);
        }

        /* Ticker Container */
        .ticker-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            padding: 20px 0;
        }

        /* Background Ticker Layer */
        .ticker-background {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            opacity: 0.3;
            z-index: 5;
            pointer-events: none;
        }
        
        .ticker-background .ticker-item a {
            pointer-events: auto;
        }

        .ticker-background-top {
            top: 0;
            align-items: flex-start;
            padding-top: 40px;
        }

        .ticker-background-bottom {
            bottom: 0;
            align-items: flex-end;
            padding-bottom: 40px;
            opacity: 0.6;
        }

        /* Individual feed tickers - even more in background */
        .ticker-feed {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            opacity: 0.15;
            z-index: 1;
            pointer-events: none;
            -webkit-transform: translateZ(0);
            transform: translateZ(0); /* GPU acceleration */
        }
        
        .ticker-feed .ticker-item a {
            pointer-events: auto;
        }

        /* Main Ticker Layer */
        .ticker-main {
            position: relative;
            z-index: 10;
            width: 100%;
            display: flex;
            align-items: center;
            pointer-events: none;
        }
        
        .ticker-main .ticker-item a {
            pointer-events: auto;
        }

        /* Horizontal Ticker */
        .ticker-horizontal {
            display: flex;
            align-items: center;
            white-space: nowrap;
            will-change: transform;
            transform: translateZ(0); /* Force GPU acceleration */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden; /* Optimize for iPad */
        }

        /* Main ticker - uses CSS variable */
        .ticker-main .ticker-horizontal {
            animation: scroll-horizontal var(--main-speed) linear infinite;
        }

        /* Top ticker - uses CSS variable */
        .ticker-background-top .ticker-horizontal {
            animation: scroll-horizontal var(--top-speed) linear infinite;
        }

        /* Bottom ticker - uses CSS variable */
        .ticker-background-bottom .ticker-horizontal {
            animation: scroll-horizontal var(--bottom-speed) linear infinite;
        }

        /* Individual feed tickers - very slow */
        .ticker-feed .ticker-horizontal {
            animation: scroll-horizontal 900s linear infinite;
        }

        /* Make feed ticker items smaller */
        .ticker-feed .ticker-item {
            font-size: 1.2em;
            font-weight: 300;
        }

        @keyframes scroll-horizontal {
            0% {
                transform: translate3d(0, 0, 0); /* Use translate3d for GPU */
            }
            100% {
                transform: translate3d(-33.333%, 0, 0); /* Move 1/3 for tripled content */
            }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0 40px;
            font-size: 2em;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Main ticker - larger font */
        .ticker-main .ticker-item {
            font-size: 2.8em;
            font-weight: 600;
        }

        /* Background tickers - smaller font */
        .ticker-background .ticker-item {
            font-size: 1.5em;
            font-weight: 400;
        }

        .ticker-item:hover {
            color: var(--accent-color);
            transition: color 0.3s ease;
        }

        /* Highlight new/breaking articles in red */
        .ticker-item.new-article {
            color: #ff0000;
            font-weight: 700;
        }

        .ticker-item.new-article a {
            color: #ff0000;
        }

        body.light-mode .ticker-item.new-article,
        body.light-mode .ticker-item.new-article a {
            color: #cc0000;
        }

        .ticker-item::after {
            content: "‚Ä¢";
            margin-left: 40px;
            color: var(--accent-color);
            font-size: 1.5em;
        }

        .ticker-item a {
            color: inherit;
            text-decoration: none;
        }

        .ticker-item .source {
            font-size: 0.6em;
            opacity: 0.7;
            margin-right: 15px;
            padding: 5px 10px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            border-radius: 5px;
            font-weight: 700;
        }

        /* Footer Controls */
        .footer {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 3px solid var(--accent-color);
            flex-wrap: wrap;
        }

        body.light-mode .footer {
            background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 255, 255, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .opml-button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-block;
        }

        .opml-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 255, 255, 0.3);
        }

        .opml-button input[type="file"] {
            display: none;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-control label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        input[type="range"] {
            width: 150px;
            cursor: pointer;
        }

        .status {
            font-size: 0.9em;
            opacity: 0.7;
        }

        /* Loading Spinner */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments for iPad */
        @media screen and (max-width: 1024px) {
            .header h1 {
                font-size: 2em;
            }
            
            .ticker-item {
                font-size: 1.5em;
            }
            
            .controls {
                flex-wrap: wrap;
            }
        }

        @media screen and (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .ticker-item {
                font-size: 1.2em;
            }

            .footer {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Fullscreen mode - hide header and footer */
        body.fullscreen-mode .header,
        body.fullscreen-mode .footer {
            display: none !important;
        }

        /* Expand ticker container to fill fullscreen */
        body.fullscreen-mode .ticker-container {
            height: 100vh !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üì∞ Live News Ticker</h1>
        <div class="timestamp" id="timestamp">Loading...</div>
    </div>

    <!-- Ticker Container -->
    <div class="ticker-container" id="ticker-container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading news feeds...</div>
        </div>
        <!-- Individual feed tickers will be dynamically generated here -->
        <!-- Background ticker - top -->
        <div class="ticker-background ticker-background-top">
            <div class="ticker-horizontal" id="ticker-bg-top"></div>
        </div>
        <!-- Main ticker - center -->
        <div class="ticker-main">
            <div class="ticker-horizontal" id="ticker"></div>
        </div>
        <!-- Background ticker - bottom -->
        <div class="ticker-background ticker-background-bottom">
            <div class="ticker-horizontal" id="ticker-bg-bottom"></div>
        </div>
    </div>

    <!-- Footer Controls -->
    <div class="footer">
        <div class="controls">
            <button id="themeToggle">üåì Toggle Theme</button>
            <button id="pausePlay">‚è∏Ô∏è Pause</button>
            <button id="refreshBtn">üîÑ Refresh</button>
            <button id="fullscreenBtn">‚õ∂ Fullscreen</button>
            <label for="opmlUpload" class="opml-button" title="Import OPML file from your RSS reader">
                üì• Import OPML
                <input type="file" id="opmlUpload" accept=".opml,.xml">
            </label>
        </div>
        
        <div class="speed-control">
            <label for="mainSpeedSlider">Main:</label>
            <input type="range" id="mainSpeedSlider" min="50" max="1200" value="250" step="10">
            <span id="mainSpeedValue">250s</span>

            <label for="topSpeedSlider" style="margin-left: 20px;">Top:</label>
            <input type="range" id="topSpeedSlider" min="50" max="1200" value="300" step="10">
            <span id="topSpeedValue">300s</span>

            <label for="bottomSpeedSlider" style="margin-left: 20px;">Bottom:</label>
            <input type="range" id="bottomSpeedSlider" min="50" max="1800" value="1200" step="10">
            <span id="bottomSpeedValue">1200s</span>
        </div>
        
        <div class="status" id="status">Initializing...</div>
    </div>

    <script>
        // Configuration - feeds will be loaded from feeds.json
        const CONFIG = {
            feeds: [],
            dailyMailUrl: 'https://www.dailymail.co.uk/articles.rss',
            refreshInterval: 10 * 60 * 1000, // 10 minutes (will be overridden by feeds.json)
            corsProxy: 'https://corsproxy.io/?' // CORS proxy for RSS feeds
        };

        // Load feeds from external JSON file
        async function loadFeedsConfig() {
            try {
                const response = await fetch('feeds.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const config = await response.json();
                
                // Update CONFIG with loaded values
                CONFIG.feeds = config.feeds || [];
                CONFIG.dailyMailUrl = config.dailyMailUrl || CONFIG.dailyMailUrl;
                CONFIG.refreshInterval = config.refreshInterval || CONFIG.refreshInterval;
                CONFIG.corsProxy = config.corsProxy || CONFIG.corsProxy;
                
                console.log(`Loaded ${CONFIG.feeds.length} feeds from feeds.json`);
                return true;
            } catch (error) {
                console.error('Error loading feeds.json:', error);
                console.log('Using default fallback feeds');
                // Fallback to default feeds if file doesn't exist
                CONFIG.feeds = [
                    'https://azure.status.microsoft/en-us/status/feed/',
                    'https://www.bleepingcomputer.com/feed/',
                    'https://build5nines.com/feed/',
                    'https://www.ciraltos.com/feed/',
                    'https://github.blog/changelog/label/copilot/feed/',
                    'https://azure.microsoft.com/en-us/blog/feed/',
                    'https://rcpmag.com/rss-feeds/news.aspx',
                    'https://www.dailymail.co.uk/articles.rss',
                    'http://feeds.arstechnica.com/arstechnica/index/',
                    'https://technology.blog.gov.uk/feed/',
                    'http://feeds.feedburner.com/TechDigest',
                    'https://www.computerworld.com/feed/'
                ];
                return false;
            }
        }

        // State
        let isPaused = false;
        let headlines = [];
        let feedHeadlines = []; // Store headlines grouped by feed
        let refreshTimer = null;
        let tickerFeeds = []; // Will be dynamically populated

        // DOM Elements
        const tickerContainer = document.getElementById('ticker-container');
        const ticker = document.getElementById('ticker');
        const tickerBgTop = document.getElementById('ticker-bg-top');
        const tickerBgBottom = document.getElementById('ticker-bg-bottom');
        const loading = document.getElementById('loading');
        const timestamp = document.getElementById('timestamp');
        const status = document.getElementById('status');
        const themeToggle = document.getElementById('themeToggle');
        const pausePlayBtn = document.getElementById('pausePlay');
        const refreshBtn = document.getElementById('refreshBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const mainSpeedSlider = document.getElementById('mainSpeedSlider');
        const mainSpeedValue = document.getElementById('mainSpeedValue');
        const topSpeedSlider = document.getElementById('topSpeedSlider');
        const topSpeedValue = document.getElementById('topSpeedValue');
        const bottomSpeedSlider = document.getElementById('bottomSpeedSlider');
        const bottomSpeedValue = document.getElementById('bottomSpeedValue');
        const opmlUpload = document.getElementById('opmlUpload');

        // Dynamically create individual feed ticker elements
        function createFeedTickers(feedCount) {
            // Remove existing feed tickers
            document.querySelectorAll('.ticker-feed').forEach(el => el.remove());
            tickerFeeds = [];
            
            // Find Daily Mail index
            const dailyMailIndex = CONFIG.feeds.findIndex(feed => 
                feed === CONFIG.dailyMailUrl
            );
            
            // Calculate how many tickers to create (excluding Daily Mail)
            let tickersToCreate = dailyMailIndex !== -1 ? feedCount - 1 : feedCount;
            
            // Limit individual tickers on iPad for performance (max 6 individual feeds)
            const isIPad = /iPad|Macintosh/i.test(navigator.userAgent) && 'ontouchend' in document;
            if (isIPad && tickersToCreate > 6) {
                console.log('iPad detected - limiting to 6 individual feed tickers for performance');
                tickersToCreate = 6;
            }
            
            if (tickersToCreate === 0) return;
            
            // Calculate position spacing
            const spacing = 80 / (tickersToCreate + 1); // Distribute across 80% of screen
            
            let tickerIndex = 0;
            for (let i = 0; i < feedCount; i++) {
                // Skip Daily Mail
                if (i === dailyMailIndex) continue;
                
                // Create ticker container
                const feedDiv = document.createElement('div');
                feedDiv.className = 'ticker-feed';
                feedDiv.dataset.feedIndex = i; // Store original feed index
                
                // Alternate between top and bottom, distribute evenly
                const isTop = tickerIndex % 2 === 0;
                const position = spacing * (Math.floor(tickerIndex / 2) + 1);
                
                if (isTop) {
                    feedDiv.style.top = `${position}%`;
                    feedDiv.style.alignItems = 'flex-start';
                } else {
                    feedDiv.style.bottom = `${position}%`;
                    feedDiv.style.alignItems = 'flex-end';
                }
                
                // Create horizontal ticker div
                const horizontalDiv = document.createElement('div');
                horizontalDiv.className = 'ticker-horizontal';
                horizontalDiv.id = `ticker-feed-${i}`;
                
                feedDiv.appendChild(horizontalDiv);
                
                // Insert before the background ticker (so it's behind everything)
                const firstBackground = tickerContainer.querySelector('.ticker-background');
                tickerContainer.insertBefore(feedDiv, firstBackground);
                
                // Store reference
                tickerFeeds[i] = horizontalDiv;
                
                tickerIndex++;
            }
            
            console.log(`Created ${tickersToCreate} individual feed tickers for ${feedCount} feeds`);
        }

        // Parse OPML file and extract feed URLs
        function parseOPML(opmlText) {
            try {
                const parser = new DOMParser();
                const xml = parser.parseFromString(opmlText, 'text/xml');
                
                // Check for parsing errors
                const parserError = xml.querySelector('parsererror');
                if (parserError) {
                    throw new Error('OPML parsing error');
                }

                // Extract feed URLs from outline elements
                const outlines = xml.querySelectorAll('outline[xmlUrl], outline[xmlurl]');
                const feedUrls = [];
                
                outlines.forEach(outline => {
                    const feedUrl = outline.getAttribute('xmlUrl') || outline.getAttribute('xmlurl');
                    const title = outline.getAttribute('title') || outline.getAttribute('text');
                    
                    if (feedUrl) {
                        feedUrls.push(feedUrl);
                        console.log(`Found feed: ${title || 'Untitled'} - ${feedUrl}`);
                    }
                });

                return feedUrls;
            } catch (error) {
                console.error('Error parsing OPML:', error);
                return [];
            }
        }

        // Handle OPML file upload
        opmlUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = 'Reading OPML file...';
            
            try {
                const text = await file.text();
                const feedUrls = parseOPML(text);
                
                if (feedUrls.length === 0) {
                    status.textContent = 'No feeds found in OPML file';
                    alert('No RSS feeds found in the OPML file. Please check the file format.');
                    return;
                }

                // Update CONFIG with new feeds
                CONFIG.feeds = feedUrls;
                
                // Save to localStorage for persistence
                localStorage.setItem('rssFeeds', JSON.stringify(feedUrls));
                
                status.textContent = `Imported ${feedUrls.length} feeds from OPML`;
                alert(`Successfully imported ${feedUrls.length} RSS feeds!\n\nThe page will now refresh to load your feeds.`);
                
                // Recreate feed tickers for new feed count
                createFeedTickers(feedUrls.length);
                
                // Reload feeds
                await fetchAllFeeds();
                
            } catch (error) {
                console.error('Error reading OPML file:', error);
                status.textContent = 'Error reading OPML file';
                alert('Error reading OPML file. Please make sure it\'s a valid OPML file.');
            }
            
            // Reset file input
            e.target.value = '';
        });

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            timestamp.textContent = now.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // Fetch RSS feed with timeout
        async function fetchRSSFeed(feedUrl) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

            try {
                const response = await fetch(CONFIG.corsProxy + encodeURIComponent(feedUrl), {
                    signal: controller.signal
                });

                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');

                // Check for parsing errors
                const parserError = xml.querySelector('parsererror');
                if (parserError) {
                    throw new Error('XML parsing error');
                }

                // Extract headlines (supports both RSS and Atom formats)
                const items = xml.querySelectorAll('item, entry');
                const feedTitle = xml.querySelector('channel > title, feed > title')?.textContent || 'News';

                const headlines = [];
                items.forEach(item => {
                    const title = item.querySelector('title')?.textContent;
                    const link = item.querySelector('link')?.textContent ||
                                item.querySelector('link')?.getAttribute('href');
                    // Get publication date (RSS uses pubDate, Atom uses published or updated)
                    const pubDateText = item.querySelector('pubDate, published, updated')?.textContent;
                    const pubDate = pubDateText ? new Date(pubDateText) : new Date(0);

                    if (title) {
                        headlines.push({
                            title: title.trim(),
                            link: link || '#',
                            source: feedTitle.trim(),
                            pubDate: pubDate,
                            feedUrl: feedUrl  // Store the feed URL
                        });
                    }
                });

                console.log(`‚úì Loaded ${headlines.length} items from ${feedTitle}`);
                return headlines;
            } catch (error) {
                console.error(`‚úó Error fetching feed ${feedUrl}:`, error.name === 'AbortError' ? 'Timeout' : error.message);
                return [];
            } finally {
                // Always clear timeout to prevent memory leak
                clearTimeout(timeoutId);
            }
        }

        // Fetch all feeds
        async function fetchAllFeeds() {
            status.textContent = 'Fetching feeds...';
            loading.style.display = 'block';
            
            console.log(`Starting to fetch ${CONFIG.feeds.length} feeds...`);
            
            // Ensure we have the right number of ticker elements
            if (tickerFeeds.length !== CONFIG.feeds.length) {
                createFeedTickers(CONFIG.feeds.length);
            }
            
            const allHeadlines = [];
            feedHeadlines = []; // Reset feed-specific headlines
            
            // Fetch all feeds in parallel with timeout
            const results = await Promise.allSettled(
                CONFIG.feeds.map(feed => fetchRSSFeed(feed))
            );
            
            let successCount = 0;
            results.forEach((result, index) => {
                if (result.status === 'fulfilled' && result.value.length > 0) {
                    allHeadlines.push(...result.value);
                    feedHeadlines[index] = result.value; // Store by feed index
                    successCount++;
                } else {
                    feedHeadlines[index] = []; // Empty array for failed feeds
                }
            });

            console.log(`Fetched ${successCount}/${CONFIG.feeds.length} feeds successfully`);

            if (allHeadlines.length === 0) {
                // Fallback headlines if no feeds load
                console.warn('No headlines loaded, using fallback');
                allHeadlines.push(
                    { title: 'Welcome to your iPad News Ticker!', source: 'System', link: '#', pubDate: new Date() },
                    { title: 'Configure your RSS feeds by editing the CONFIG.feeds array', source: 'System', link: '#', pubDate: new Date() },
                    { title: 'Headlines will scroll continuously once loaded', source: 'System', link: '#', pubDate: new Date() }
                );
            }

            // Sort headlines by publication date (newest first)
            allHeadlines.sort((a, b) => b.pubDate - a.pubDate);

            headlines = allHeadlines;
            renderTicker();
            loading.style.display = 'none';
            status.textContent = `Loaded ${headlines.length} headlines from ${successCount}/${CONFIG.feeds.length} feeds`;
            updateTimestamp();
        }

        // Render ticker
        function renderTicker() {
            if (headlines.length === 0) return;
            
            console.log(`Filtering with Daily Mail URL: ${CONFIG.dailyMailUrl}`);

            // Filter headlines to last 10 days for main tickers (prioritizes newest first)
            const tenDaysAgo = new Date(Date.now() - 10 * 24 * 60 * 60 * 1000);
            const recentHeadlines = headlines.filter(h => h.pubDate >= tenDaysAgo);

            console.log(`Total headlines: ${headlines.length}, Recent (10 days): ${recentHeadlines.length}`);
            
            // Use recent headlines for main tickers, all headlines for background
            const headlinesToUse = recentHeadlines.length > 0 ? recentHeadlines : headlines;
            
            // Separate Daily Mail headlines from others based on feed URL
            const dailyMailHeadlines = headlinesToUse.filter(h => h.feedUrl === CONFIG.dailyMailUrl);
            const otherHeadlines = headlinesToUse.filter(h => h.feedUrl !== CONFIG.dailyMailUrl);
            
            console.log(`Daily Mail headlines: ${dailyMailHeadlines.length}, Other headlines: ${otherHeadlines.length}`);
            console.log(`First few feed URLs:`, headlines.slice(0, 3).map(h => h.feedUrl));

            // Don't split - use ALL non-Daily Mail articles for both main and top
            // Users want to see all available content, not just half
            const mainHeadlines = otherHeadlines;
            const topHeadlines = otherHeadlines;

            console.log(`Main feed will show: ${mainHeadlines.length} unique articles`);

            // Show all available headlines - users want to see everything from 12 feeds
            const maxMainItems = 500;
            const maxTopItems = 500;
            const maxBottomItems = 500;
            const maxIndividualItems = 100;
            
            // Use Daily Mail for bottom, ensure we have content for all layers
            const safeMainHeadlines = (mainHeadlines.length > 0 ? mainHeadlines : otherHeadlines.length > 0 ? otherHeadlines : headlines).slice(0, maxMainItems);
            const safeTopHeadlines = (topHeadlines.length > 0 ? topHeadlines : otherHeadlines.length > 0 ? otherHeadlines : headlines).slice(0, maxTopItems);
            const safeBottomHeadlines = (dailyMailHeadlines.length > 0 ? dailyMailHeadlines : headlines).slice(0, maxBottomItems);
            
            // Duplicate headlines for seamless loop (3x for smooth scrolling)
            const renderTickerContent = (headlineArray) => {
                const tripled = [...headlineArray, ...headlineArray, ...headlineArray];
                const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);

                return tripled.map(item => {
                    // Mark articles from last 6 hours as new/breaking
                    const isNew = item.pubDate >= sixHoursAgo;
                    const newClass = isNew ? ' new-article' : '';

                    return `
                        <div class="ticker-item${newClass}">
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer">
                                ${item.title}
                            </a>
                        </div>
                    `;
                }).join('');
            };
            
            // Populate all three ticker layers (use recent 24h headlines)
            ticker.innerHTML = renderTickerContent(safeMainHeadlines);
            tickerBgTop.innerHTML = renderTickerContent(safeTopHeadlines);
            tickerBgBottom.innerHTML = renderTickerContent(safeBottomHeadlines);
            
            // Find Daily Mail index
            const dailyMailIndex = CONFIG.feeds.findIndex(feed => 
                feed === CONFIG.dailyMailUrl
            );
            
            // Populate individual feed tickers (excluding Daily Mail) - use ALL headlines, not just 24h
            feedHeadlines.forEach((feedHeads, index) => {
                // Skip Daily Mail
                if (index === dailyMailIndex) return;
                
                console.log(`Feed ${index}: ${CONFIG.feeds[index]?.substring(0, 50)}... has ${feedHeads.length} headlines`);
                
                if (tickerFeeds[index]) {
                    // Use this feed's headlines if available, but cap at maxIndividualItems
                    if (feedHeads.length > 0) {
                        const limitedHeads = feedHeads.slice(0, maxIndividualItems);
                        tickerFeeds[index].innerHTML = renderTickerContent(limitedHeads);
                        console.log(`  -> Populated ticker-feed-${index} with ${limitedHeads.length} items`);
                    } else {
                        // Clear if no content
                        tickerFeeds[index].innerHTML = '';
                        console.log(`  -> Cleared ticker-feed-${index} (no content)`);
                    }
                } else {
                    console.log(`  -> WARNING: tickerFeeds[${index}] does not exist!`);
                }
            });
            
            console.log(`Populated ${feedHeadlines.filter((f, i) => i !== dailyMailIndex && f.length > 0).length} individual feed tickers`);
        }

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        });

        // Pause/Play toggle
        pausePlayBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            const playState = isPaused ? 'paused' : 'running';
            ticker.style.animationPlayState = playState;
            tickerBgTop.style.animationPlayState = playState;
            tickerBgBottom.style.animationPlayState = playState;
            tickerFeeds.forEach(feed => {
                if (feed) {
                    feed.style.animationPlayState = playState;
                }
            });
            pausePlayBtn.textContent = isPaused ? '‚ñ∂Ô∏è Play' : '‚è∏Ô∏è Pause';
        });

        // Refresh feeds
        refreshBtn.addEventListener('click', () => {
            fetchAllFeeds();
        });

        // Fullscreen toggle
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                // Enter fullscreen
                document.documentElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen-mode');
                    fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
                }).catch(err => {
                    console.error('Error entering fullscreen:', err);
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen-mode');
                    fullscreenBtn.textContent = '‚õ∂ Fullscreen';
                }).catch(err => {
                    console.error('Error exiting fullscreen:', err);
                });
            }
        });

        // Detect F11 fullscreen and manual fullscreen changes
        function checkFullscreenState() {
            // Check if in fullscreen (works for both F11 and Fullscreen API)
            const isFullscreen = window.innerHeight === screen.height || document.fullscreenElement;

            if (isFullscreen) {
                document.body.classList.add('fullscreen-mode');
                fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
            } else {
                document.body.classList.remove('fullscreen-mode');
                fullscreenBtn.textContent = '‚õ∂ Fullscreen';
            }
        }

        // Listen for fullscreen changes (catches Fullscreen API and F11)
        document.addEventListener('fullscreenchange', checkFullscreenState);
        document.addEventListener('webkitfullscreenchange', checkFullscreenState);
        document.addEventListener('mozfullscreenchange', checkFullscreenState);
        document.addEventListener('MSFullscreenChange', checkFullscreenState);

        // Listen for window resize (catches F11)
        window.addEventListener('resize', checkFullscreenState);

        // Helper function to restart animation
        function restartAnimation(element) {
            // Remove animation
            const currentAnimation = element.style.animation;
            element.style.animation = 'none';
            // Force reflow
            element.offsetHeight;
            // Restore animation
            element.style.animation = currentAnimation || '';
        }

        // Speed controls
        mainSpeedSlider.addEventListener('input', (e) => {
            const speed = e.target.value;
            mainSpeedValue.textContent = `${speed}s`;
            document.documentElement.style.setProperty('--main-speed', `${speed}s`);
            localStorage.setItem('mainScrollSpeed', speed);
            // Restart animation to apply new speed
            restartAnimation(ticker);
        });

        topSpeedSlider.addEventListener('input', (e) => {
            const speed = e.target.value;
            topSpeedValue.textContent = `${speed}s`;
            document.documentElement.style.setProperty('--top-speed', `${speed}s`);
            localStorage.setItem('topScrollSpeed', speed);
            // Restart animation to apply new speed
            restartAnimation(tickerBgTop);
        });

        bottomSpeedSlider.addEventListener('input', (e) => {
            const speed = e.target.value;
            bottomSpeedValue.textContent = `${speed}s`;
            document.documentElement.style.setProperty('--bottom-speed', `${speed}s`);
            localStorage.setItem('bottomScrollSpeed', speed);
            // Restart animation to apply new speed
            restartAnimation(tickerBgBottom);
        });

        // Auto-refresh feeds
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (!isPaused) {
                    fetchAllFeeds();
                }
            }, CONFIG.refreshInterval);
        }

        // Initialize
        async function init() {
            // Load feeds configuration from external file FIRST
            await loadFeedsConfig();
            
            // Check if localStorage has old feeds - if so, clear it to use feeds.json
            const savedFeeds = localStorage.getItem('rssFeeds');
            if (savedFeeds) {
                console.warn('Found old feeds in localStorage - removing to use feeds.json');
                localStorage.removeItem('rssFeeds');
            }
            
            console.log(`CONFIG.dailyMailUrl set to: ${CONFIG.dailyMailUrl}`);
            
            // Create individual feed tickers based on current feed count
            createFeedTickers(CONFIG.feeds.length);

            // Restore theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }

            // Restore scroll speeds
            const savedMainSpeed = localStorage.getItem('mainScrollSpeed');
            if (savedMainSpeed) {
                mainSpeedSlider.value = savedMainSpeed;
                mainSpeedValue.textContent = `${savedMainSpeed}s`;
                document.documentElement.style.setProperty('--main-speed', `${savedMainSpeed}s`);
            }

            const savedTopSpeed = localStorage.getItem('topScrollSpeed');
            if (savedTopSpeed) {
                topSpeedSlider.value = savedTopSpeed;
                topSpeedValue.textContent = `${savedTopSpeed}s`;
                document.documentElement.style.setProperty('--top-speed', `${savedTopSpeed}s`);
            }

            const savedBottomSpeed = localStorage.getItem('bottomScrollSpeed');
            if (savedBottomSpeed) {
                bottomSpeedSlider.value = savedBottomSpeed;
                bottomSpeedValue.textContent = `${savedBottomSpeed}s`;
                document.documentElement.style.setProperty('--bottom-speed', `${savedBottomSpeed}s`);
            }

            // Update timestamp every minute
            updateTimestamp();
            setInterval(updateTimestamp, 60000);

            // Load feeds
            await fetchAllFeeds();

            // Start auto-refresh
            startAutoRefresh();
        }

        // Prevent accidental zoom on iPad
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });

        // Start the app
        init();
    </script>
</body>
</html>
